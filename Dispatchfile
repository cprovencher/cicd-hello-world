#!starlark
# vi:syntax=python
#
#

def secretVar(name, key):
    return k8s.corev1.EnvVarSource(secretKeyRef=k8s.corev1.SecretKeySelector(localObjectReference=k8s.corev1.LocalObjectReference(name=name), key=key))

gitResource("src-git")

dindTask("pr-helper", inputs=["src-git"], steps=[
  v1.Container(
      name="pr-helper",
      image="mesosphere/konvoy-soak:pr_helper",
      workingDir="/workspace/src-git/",
      args=["python3", "pr_helper.py", "$(context.build.name)"],
      env=[k8s.corev1.EnvVar(name="GITHUB_TOKEN", valueFrom=secretVar("cprovencher-basic-auth", "password"))]
  )
])

action(tasks=["pr-helper"], on=pullRequest())

