#!starlark
# vi:syntax=python
#
#

def secretVar(name, key):
    return k8s.corev1.EnvVarSource(secretKeyRef=k8s.corev1.SecretKeySelector(localObjectReference=k8s.corev1.LocalObjectReference(name=name), key=key))

gitResource("src-git",
    url="$(context.git.url)",
    revision="$(context.git.commit)")


task("pr-helper", inputs=["src-git"], steps=[
  v1.Container(
      name="pr-helper",
      image="python:alpine3.12",
      workingDir="/workspace/src-git",
      command=["/bin/sh"],
      args=[
        "-c",
        """
        pip install requests
        python pr_helper.py $(context.build.name)
        """
      ],
      env=[k8s.corev1.EnvVar(name="GITHUB_TOKEN", valueFrom=secretVar("cprovencher-basic-auth", "password"))]
  )
])

action(tasks=["pr-helper"], on=pullRequest())

