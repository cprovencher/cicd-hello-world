#!starlark
# vi:syntax=python
#
#

def secretVar(name, key):
    return k8s.corev1.EnvVarSource(secretKeyRef=k8s.corev1.SecretKeySelector(localObjectReference=k8s.corev1.LocalObjectReference(name=name), key=key))

gitResource("src-git",
    url="$(context.git.url)",
    revision="$(context.git.commit)")

dindTask("pr-helper", inputs=["src-git"], steps=[
  v1.Container(
      name="pr-helper",
      image="mesosphere/konvoy-soak:pr-helper",
      workingDir="/workspace/src-git/",
      args=["python3", "pr_helper.py", "$(context.build.name)"],
      env=[k8s.corev1.EnvVar(name="GITHUB_TOKEN", valueFrom=secretVar("cprovencher-gist-creator", "password"))],
      resources = k8s.corev1.ResourceRequirements(
          limits = {
              "cpu": k8s.resource_quantity("1000m"),
              "memory": k8s.resource_quantity("6Gi")
          }
      )
  )
])

action(tasks=["pr-helper"], on=pullRequest())

